<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ryuuda - Server Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg0: #07060a; --bg1: #0a0810; --text: rgba(255, 255, 255, 0.92);
            --muted: rgba(255, 255, 255, 0.7); --line: rgba(255, 255, 255, 0.1);
            --fire1: #ff2a1a; --fire2: #ff6a00; --fire3: #ffd000;
            --radius: 16px; --card-bg: rgba(255, 255, 255, 0.03);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(180deg, var(--bg1), var(--bg0));
            color: var(--text); min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; border-bottom: 1px solid var(--line); margin-bottom: 30px;
            flex-wrap: wrap; gap: 20px;
        }
        .header h1 { font-size: 1.8rem; background: linear-gradient(90deg, var(--fire3), var(--fire2)); -webkit-background-clip: text; background-clip: text; color: transparent; }
        
        /* Server Info Card */
        .server-header {
            background: var(--card-bg); border-radius: var(--radius); padding: 25px;
            border: 1px solid var(--line); margin-bottom: 30px;
        }
        .server-basic-info {
            display: flex; align-items: center; gap: 20px; margin-bottom: 20px;
        }
        .server-icon-large {
            width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--fire2);
            background: linear-gradient(135deg, var(--fire1), var(--fire2));
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; font-weight: bold; color: white;
        }
        .server-stats {
            display: flex; gap: 20px; flex-wrap: wrap;
        }
        .stat-card {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: var(--radius);
            flex: 1; min-width: 150px; text-align: center;
        }
        .stat-number { font-size: 1.8rem; font-weight: bold; color: var(--fire2); }
        .stat-label { font-size: 0.9rem; color: var(--muted); margin-top: 5px; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--line); padding-bottom: 10px; }
        .tab { 
            padding: 12px 24px; background: transparent; border: none; color: var(--muted);
            border-radius: var(--radius); cursor: pointer; font-weight: bold;
            transition: all 0.2s ease;
        }
        .tab.active { background: rgba(255, 106, 0, 0.15); color: var(--fire2); }
        .tab:hover:not(.active) { background: rgba(255,255,255,0.05); color: var(--text); }
        
        /* Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .settings-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px; margin-top: 20px;
        }
        .setting-card {
            background: var(--card-bg); border: 1px solid var(--line); border-radius: var(--radius);
            padding: 20px;
        }
        .setting-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .setting-description { font-size: 0.9rem; color: var(--muted); margin-bottom: 15px; }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative; display: inline-block; width: 50px; height: 26px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255,255,255,0.1); transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--fire2); }
        input:checked + .slider:before { transform: translateX(24px); }
        
        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px;
            border-radius: 999px; border: none; font-weight: bold; cursor: pointer;
            transition: all 0.2s ease; text-decoration: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--fire1), var(--fire2)); color: white;
        }
        .btn-secondary {
            background: var(--card-bg); color: var(--text); border: 1px solid var(--line);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 60, 20, 0.3); }
        
        /* Footer */
        .footer {
            margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--line);
            color: var(--muted); font-size: 0.9rem; text-align: center;
        }
        
        /* Loading */
        .loading { text-align: center; padding: 60px; font-size: 1.2rem; color: var(--muted); }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div>
                <h1><i class="fas fa-cog"></i> Server Management</h1>
                <p style="color: var(--muted); margin-top: 5px;">Configure Ryuuda for this server</p>
            </div>
            <div id="user-profile-container"></div>
        </header>

        <main>
            <!-- Server Info will be loaded here -->
            <div id="server-info-container" class="loading">
                <div class="spinner" style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--fire2); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                Loading server information...
            </div>
            
            <!-- Tabs -->
            <div class="tabs" id="tabs-container" style="display: none;">
                <button class="tab active" data-tab="general"><i class="fas fa-sliders-h"></i> General</button>
                <button class="tab" data-tab="moderation"><i class="fas fa-shield-alt"></i> Moderation</button>
                <button class="tab" data-tab="fun"><i class="fas fa-gamepad"></i> Fun</button>
                <button class="tab" data-tab="automation"><i class="fas fa-robot"></i> Automation</button>
                <button class="tab" data-tab="logs"><i class="fas fa-clipboard-list"></i> Logs</button>
            </div>
            
            <!-- Tab Contents -->
            <div id="tab-contents">
                <!-- Content loaded dynamically -->
            </div>
        </main>

        <footer class="footer">
            <div>Â© <span id="current-year"></span> Ryuuda | <strong>@neporrex</strong> on discord.</div>
            <div style="margin-top: 10px;">
                <a href="../" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </footer>
    </div>

    <script>
    document.getElementById('current-year').textContent = new Date().getFullYear();
    
    // Get server ID from URL
    const pathParts = window.location.pathname.split('/');
    const serverId = pathParts[pathParts.length - 1];
    
    // Discord OAuth config
    const DISCORD_CONFIG = {
        clientId: '1456640479201595453',
        redirectUri: window.location.href,
        scope: 'identify guilds',
        responseType: 'token',
    };

    class ServerManager {
        constructor(serverId) {
            this.serverId = serverId;
            this.user = null;
            this.accessToken = null;
            this.server = null;
            this.settings = {};
            this.init();
        }

        async init() {
            this.parseTokenFromHash();
            await this.checkAuth();
            
            if (this.user && this.accessToken) {
                this.renderUserProfile();
                await this.fetchServerInfo();
            } else {
                this.showLoginPrompt();
            }
        }

        parseTokenFromHash() {
            if (window.location.hash) {
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                this.accessToken = params.get('access_token');
                
                if (this.accessToken) {
                    sessionStorage.setItem('discord_access_token', this.accessToken);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } else {
                this.accessToken = sessionStorage.getItem('discord_access_token');
            }
        }

        async checkAuth() {
            if (!this.accessToken) return false;
            
            try {
                const response = await fetch('https://discord.com/api/users/@me', {
                    headers: { 'Authorization': `Bearer ${this.accessToken}` }
                });
                
                if (response.ok) {
                    this.user = await response.json();
                    return true;
                } else {
                    this.logout();
                    return false;
                }
            } catch (error) {
                console.error('Auth error:', error);
                return false;
            }
        }

        async fetchServerInfo() {
            try {
                // Get user's guilds to check permissions
                const response = await fetch('https://discord.com/api/users/@me/guilds', {
                    headers: { 'Authorization': `Bearer ${this.accessToken}` }
                });
                
                if (response.ok) {
                    const guilds = await response.json();
                    const thisGuild = guilds.find(g => g.id === this.serverId);
                    
                    if (!thisGuild) {
                        this.showError('Server not found or you lack permissions');
                        return;
                    }
                    
                    // Check if user has admin/manage server permission
                    const hasPermission = (thisGuild.permissions & 0x8) === 0x8 || 
                                          (thisGuild.permissions & 0x20) === 0x20;
                    
                    if (!hasPermission) {
                        this.showError('You need Administrator or "Manage Server" permission to configure this server');
                        return;
                    }
                    
                    this.server = thisGuild;
                    this.renderServerInfo();
                    this.setupTabs();
                    await this.loadSettings();
                    
                } else {
                    throw new Error('Failed to fetch server info');
                }
            } catch (error) {
                console.error('Failed to fetch server:', error);
                this.showError('Failed to load server information');
            }
        }

        renderServerInfo() {
            const container = document.getElementById('server-info-container');
            const iconUrl = this.server.icon 
                ? `https://cdn.discordapp.com/icons/${this.server.id}/${this.server.icon}.png?size=256`
                : null;
            
            container.innerHTML = `
                <div class="server-header">
                    <div class="server-basic-info">
                        ${iconUrl ? 
                            `<img src="${iconUrl}" class="server-icon-large" alt="${this.server.name}" onerror="this.style.display='none';this.parentElement.innerHTML+='<div class=\\'server-icon-large\\'>${this.server.name.charAt(0).toUpperCase()}</div>'">` : 
                            `<div class="server-icon-large">${this.server.name.charAt(0).toUpperCase()}</div>`
                        }
                        <div>
                            <h2 style="font-size: 2rem; margin-bottom: 5px;">${this.server.name}</h2>
                            <p style="color: var(--muted);">Server ID: ${this.server.id}</p>
                            <p style="color: var(--muted); margin-top: 5px;">
                                <i class="fas fa-crown"></i> ${this.server.owner ? 'You own this server' : 'You manage this server'}
                            </p>
                        </div>
                    </div>
                    
                    <div class="server-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="member-count">?</div>
                            <div class="stat-label">Total Members</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="command-count">0</div>
                            <div class="stat-label">Commands Used</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="active-count">0</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Show tabs
            document.getElementById('tabs-container').style.display = 'flex';
            
            // Try to fetch server stats from bot
            this.fetchServerStats();
        }

        async fetchServerStats() {
            try {
                // Try to get member count from Discord API
                const response = await fetch(`/api/server-stats?guildId=${this.serverId}`);
                if (response.ok) {
                    const stats = await response.json();
                    if (stats.member_count) {
                        document.getElementById('member-count').textContent = stats.member_count;
                    }
                }
            } catch (error) {
                console.log('Could not fetch server stats:', error.message);
            }
        }

        setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.getElementById('tab-contents');
            
            // Load initial tab
            this.loadTabContent('general');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    // Load content
                    this.loadTabContent(tab.dataset.tab);
                });
            });
        }

        loadTabContent(tabName) {
            const container = document.getElementById('tab-contents');
            
            const tabContents = {
                'general': this.getGeneralSettings(),
                'moderation': this.getModerationSettings(),
                'fun': this.getFunSettings(),
                'automation': this.getAutomationSettings(),
                'logs': this.getLogsSettings()
            };
            
            container.innerHTML = tabContents[tabName] || '<div class="loading">Coming soon...</div>';
            
            // Apply current settings to the form
            setTimeout(() => {
                this.applyCurrentTabSettings(tabName);
            }, 100);
        }

        getGeneralSettings() {
            return `
                <div class="tab-content active">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-sliders-h"></i> General Settings</h3>
                    <div class="settings-grid">
                        <div class="setting-card">
                            <div class="setting-title"><i class="fas fa-language"></i> Command Prefix</div>
                            <div class="setting-description">The prefix used for text commands</div>
                            <input type="text" id="prefix" placeholder="!" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--line); border-radius: 8px; color: var(--text); margin-top: 10px;">
                        </div>
                        
                        <div class="setting-card">
                            <div class="setting-title"><i class="fas fa-bell"></i> Welcome Messages</div>
                            <div class="setting-description">Send welcome message when users join</div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                    <input type="checkbox" id="welcome_enabled">
                                    <span>Enable welcome messages</span>
                                </label>
                                <textarea id="welcome_message" placeholder="Welcome {user} to {server}! ðŸ‘‹" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--line); border-radius: 8px; color: var(--text); min-height: 80px; resize: vertical;"></textarea>
                                <small style="color: var(--muted); font-size: 0.8rem; display: block; margin-top: 5px;">
                                    Variables: {user}, {server}, {member_count}
                                </small>
                            </div>
                        </div>
                        
                        <div class="setting-card">
                            <div class="setting-title"><i class="fas fa-robot"></i> Bot Nickname</div>
                            <div class="setting-description">Custom nickname for Ryuuda in this server</div>
                            <input type="text" id="bot_nickname" placeholder="Ryuuda" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--line); border-radius: 8px; color: var(--text); margin-top: 10px;">
                        </div>
                        
                        <div class="setting-card">
                            <div class="setting-title"><i class="fas fa-hashtag"></i> Welcome Channel</div>
                            <div class="setting-description">Channel where welcome messages are sent</div>
                            <input type="text" id="welcome_channel" placeholder="#general or channel ID" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--line); border-radius: 8px; color: var(--text); margin-top: 10px;">
                        </div>
                    </div>
                    
                    <button onclick="serverManager.saveCurrentTab('general')" class="btn btn-primary" style="margin-top: 30px; padding: 12px 30px; font-size: 1rem;">
                        <i class="fas fa-save"></i> Save General Settings
                    </button>
                </div>
            `;
        }

        getModerationSettings() {
            return `
                <div class="tab-content active">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-shield-alt"></i> Moderation Settings</h3>
                    <div class="settings-grid">
                        <div class="setting-card">
                            <div class="setting-title"><i class="fas fa-ban"></i> Auto-Moderation</div>
                            <div class="setting-description">Automatically moderate bad content</div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <input type="checkbox" id="mod_spam">
                                    <span>Block spam messages</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <input type="checkbox" id="mod_links">
                                    <span>Block suspicious links</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="mod_mentions">
                                    <span>Block mass mentions</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-card">
                            <div class="setting-title"><i class="fas fa-exclamation-triangle"></i> Logging Channel</div>
                            <div class="setting-description">Log moderation actions to a channel</div>
                            <div style="margin-top: 15px;">
                                <input type="text" id="mod_log_channel" placeholder="#mod-logs or channel ID" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--line); border-radius: 8px; color: var(--text);">
                            </div>
                        </div>
                        
                        <div class="setting-card">
                            <div class="setting-title"><i class="fas fa-user-slash"></i> Auto-Role</div>
                            <div class="setting-description">Role to give new members automatically</div>
                            <div style="margin-top: 15px;">
                                <input type="text" id="auto_role" placeholder="Role name or ID" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--line); border-radius: 8px; color: var(--text);">
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="serverManager.saveCurrentTab('moderation')" class="btn btn-primary" style="margin-top: 30px; padding: 12px 30px; font-size: 1rem;">
                        <i class="fas fa-save"></i> Save Moderation Settings
                    </button>
                </div>
            `;
        }

        getFunSettings() {
            return `
                <div class="tab-content active">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-gamepad"></i> Fun & Games</h3>
                    <div class="settings-grid">
                        <div class="setting-card">
                            <div class="setting-title"><i class="fas fa-gem"></i> Economy System</div>
                            <div class="setting-description">Enable coins, shop, and economy commands</div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="economy_enabled">
                                    <span>Enable economy system</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-card">
                            <div class="setting-title"><i class="fas fa-trophy"></i> Leveling System</div>
                            <div class="setting-description">XP and levels for active users</div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="leveling_enabled">
                                    <span>Enable leveling system</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="setting-card">
                            <div class="setting-title"><i class="fas fa-images"></i> Image Commands</div>
                            <div class="setting-description">Enable meme, cat, dog commands</div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="images_enabled">
                                    <span>Enable image commands</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="serverManager.saveCurrentTab('fun')" class="btn btn-primary" style="margin-top: 30px; padding: 12px 30px; font-size: 1rem;">
                        <i class="fas fa-save"></i> Save Fun Settings
                    </button>
                </div>
            `;
        }

        getAutomationSettings() {
            return `
                <div class="tab-content active">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-robot"></i> Automation</h3>
                    <div class="settings-grid">
                        <div class="setting-card">
                            <div class="setting-title"><i class="fas fa-sync-alt"></i> Auto-Responses</div>
                            <div class="setting-description">Bot automatically responds to keywords</div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <input type="checkbox" id="auto_responses">
                                    <span>Enable auto-responses</span>
                                </label>
                                <textarea id="response_keywords" placeholder="hello=Hi there!\ngood morning=Good morning! â˜€ï¸" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--line); border-radius: 8px; color: var(--text); min-height: 100px; resize: vertical; margin-top: 10px;" disabled></textarea>
                                <small style="color: var(--muted); font-size: 0.8rem; display: block; margin-top: 5px;">
                                    Format: keyword=response (one per line)
                                </small>
                            </div>
                        </div>
                        
                        <div class="setting-card">
                            <div class="setting-title"><i class="fas fa-clock"></i> Scheduled Messages</div>
                            <div class="setting-description">Send messages at specific times</div>
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                    <input type="checkbox" id="scheduled_messages">
                                    <span>Enable scheduled messages</span>
                                </label>
                                <textarea id="scheduled_config" placeholder="12:00=Good afternoon everyone!\n18:00=Have a great evening! ðŸŒ™" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--line); border-radius: 8px; color: var(--text); min-height: 100px; resize: vertical;" disabled></textarea>
                                <small style="color: var(--muted); font-size: 0.8rem; display: block; margin-top: 5px;">
                                    Format: HH:MM=message (24-hour format)
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="serverManager.saveCurrentTab('automation')" class="btn btn-primary" style="margin-top: 30px; padding: 12px 30px; font-size: 1rem;">
                        <i class="fas fa-save"></i> Save Automation Settings
                    </button>
                </div>
            `;
        }

        getLogsSettings() {
            return `
                <div class="tab-content active">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-clipboard-list"></i> Activity Logs</h3>
                    <div class="loading" style="padding: 40px; text-align: center;">
                        <i class="fas fa-history" style="font-size: 3rem; color: var(--muted); margin-bottom: 20px;"></i>
                        <h4>Recent Activity</h4>
                        <p style="color: var(--muted); margin: 15px 0;">Activity logs will appear here</p>
                        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: var(--radius); border: 1px solid var(--line); margin-top: 20px;">
                            <p style="color: var(--muted); font-size: 0.9rem;">
                                <i class="fas fa-info-circle"></i> Logs show: commands used, moderation actions, errors
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        async loadSettings() {
            try {
                // Load settings from your backend
                const response = await fetch(`/api/server-settings?guildId=${this.serverId}`);
                if (response.ok) {
                    this.settings = await response.json();
                } else {
                    // Use default settings
                    this.settings = this.getDefaultSettings();
                }
            } catch (error) {
                console.log('Using default settings:', error.message);
                this.settings = this.getDefaultSettings();
            }
        }

        getDefaultSettings() {
            return {
                guild_id: this.serverId,
                prefix: '!',
                welcome_enabled: true,
                welcome_message: 'Welcome {user} to {server}! ðŸ‘‹',
                welcome_channel: '',
                bot_nickname: '',
                mod_log_channel: '',
                auto_role: '',
                economy_enabled: true,
                leveling_enabled: true,
                images_enabled: true,
                mod_spam: true,
                mod_links: true,
                mod_mentions: false,
                auto_responses: false,
                scheduled_messages: false
            };
        }

        applyCurrentTabSettings(tabName) {
            // Apply settings to the current tab's form elements
            
            if (tabName === 'general') {
                if (this.settings.prefix) {
                    const element = document.getElementById('prefix');
                    if (element) element.value = this.settings.prefix;
                }
                
                if (this.settings.welcome_enabled !== undefined) {
                    const element = document.getElementById('welcome_enabled');
                    if (element) element.checked = this.settings.welcome_enabled;
                }
                
                if (this.settings.welcome_message) {
                    const element = document.getElementById('welcome_message');
                    if (element) element.value = this.settings.welcome_message;
                }
                
                if (this.settings.bot_nickname) {
                    const element = document.getElementById('bot_nickname');
                    if (element) element.value = this.settings.bot_nickname;
                }
                
                if (this.settings.welcome_channel) {
                    const element = document.getElementById('welcome_channel');
                    if (element) element.value = this.settings.welcome_channel;
                }
            }
            
            if (tabName === 'moderation') {
                const modSettings = ['mod_spam', 'mod_links', 'mod_mentions'];
                modSettings.forEach(id => {
                    const element = document.getElementById(id);
                    if (element && this.settings[id] !== undefined) {
                        element.checked = this.settings[id];
                    }
                });
                
                if (this.settings.mod_log_channel) {
                    const element = document.getElementById('mod_log_channel');
                    if (element) element.value = this.settings.mod_log_channel;
                }
                
                if (this.settings.auto_role) {
                    const element = document.getElementById('auto_role');
                    if (element) element.value = this.settings.auto_role;
                }
            }
            
            if (tabName === 'fun') {
                const funSettings = ['economy_enabled', 'leveling_enabled', 'images_enabled'];
                funSettings.forEach(id => {
                    const element = document.getElementById(id);
                    if (element && this.settings[id] !== undefined) {
                        element.checked = this.settings[id];
                    }
                });
            }
            
            if (tabName === 'automation') {
                const autoSettings = ['auto_responses', 'scheduled_messages'];
                autoSettings.forEach(id => {
                    const element = document.getElementById(id);
                    if (element && this.settings[id] !== undefined) {
                        element.checked = this.settings[id];
                    }
                });
            }
        }

        async saveCurrentTab(tabName) {
            const updates = {};
            
            if (tabName === 'general') {
                updates.prefix = document.getElementById('prefix')?.value || '!';
                updates.welcome_enabled = document.getElementById('welcome_enabled')?.checked || false;
                updates.welcome_message = document.getElementById('welcome_message')?.value || '';
                updates.bot_nickname = document.getElementById('bot_nickname')?.value || '';
                updates.welcome_channel = document.getElementById('welcome_channel')?.value || '';
            }
            
            if (tabName === 'moderation') {
                updates.mod_spam = document.getElementById('mod_spam')?.checked || false;
                updates.mod_links = document.getElementById('mod_links')?.checked || false;
                updates.mod_mentions = document.getElementById('mod_mentions')?.checked || false;
                updates.mod_log_channel = document.getElementById('mod_log_channel')?.value || '';
                updates.auto_role = document.getElementById('auto_role')?.value || '';
            }
            
            if (tabName === 'fun') {
                updates.economy_enabled = document.getElementById('economy_enabled')?.checked || false;
                updates.leveling_enabled = document.getElementById('leveling_enabled')?.checked || false;
                updates.images_enabled = document.getElementById('images_enabled')?.checked || false;
            }
            
            if (tabName === 'automation') {
                updates.auto_responses = document.getElementById('auto_responses')?.checked || false;
                updates.scheduled_messages = document.getElementById('scheduled_messages')?.checked || false;
            }
            
            // Merge with existing settings
            Object.assign(this.settings, updates);
            
            try {
                // Save to database
                const response = await fetch(`/api/server-settings?guildId=${this.serverId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        settings: updates,
                        guild_id: this.serverId
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    this.showToast(`${tabName} settings saved successfully!`, 'success');
                    console.log('Saved:', result);
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                this.showToast(`Failed to save settings: ${error.message}`, 'error');
                console.error('Save error:', error);
            }
        }

        showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; bottom: 20px; right: 20px; padding: 12px 20px;
                background: ${type === 'success' ? 'rgba(87, 242, 135, 0.9)' : 'rgba(255, 80, 80, 0.9)'};
                color: white; border-radius: 8px; z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        showError(message) {
            const container = document.getElementById('server-info-container');
            container.innerHTML = `
                <div class="loading">
                    <i class="fas fa-exclamation-triangle" style="color: var(--fire2); font-size: 2rem; margin-bottom: 15px;"></i>
                    <h3>Error</h3>
                    <p style="color: var(--muted); margin: 15px 0;">${message}</p>
                    <a href="../" class="btn btn-primary" style="margin-top: 15px;">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            `;
        }

        showLoginPrompt() {
            document.getElementById('user-profile-container').innerHTML = `
                <a href="${this.getLoginUrl()}" class="btn btn-primary">
                    <i class="fab fa-discord"></i> Login with Discord
                </a>
            `;
            
            document.getElementById('server-info-container').innerHTML = `
                <div class="loading">
                    <i class="fas fa-lock" style="font-size: 3rem; color: var(--muted); margin-bottom: 20px;"></i>
                    <h3>Authentication Required</h3>
                    <p style="color: var(--muted); margin: 15px 0;">Please log in with Discord to manage this server.</p>
                </div>
            `;
        }

        getLoginUrl() {
            const params = new URLSearchParams({
                client_id: DISCORD_CONFIG.clientId,
                redirect_uri: DISCORD_CONFIG.redirectUri,
                response_type: DISCORD_CONFIG.responseType,
                scope: DISCORD_CONFIG.scope,
            });
            return `https://discord.com/oauth2/authorize?${params.toString()}`;
        }

        renderUserProfile() {
            const container = document.getElementById('user-profile-container');
            const avatarUrl = this.user.avatar 
                ? `https://cdn.discordapp.com/avatars/${this.user.id}/${this.user.avatar}.png?size=80`
                : null;
            
            container.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-radius: 999px; background: var(--card-bg); border: 1px solid var(--line);">
                    ${avatarUrl ? 
                        `<img src="${avatarUrl}" style="width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--fire2);" alt="${this.user.username}">` : 
                        `<div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--fire1), var(--fire2)); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${this.user.username.charAt(0).toUpperCase()}</div>`
                    }
                    <div>
                        <div style="font-weight: bold; font-size: 0.9rem;">${this.user.global_name || this.user.username}</div>
                        <div style="font-size: 0.8rem; color: var(--muted);">#${this.user.discriminator}</div>
                    </div>
                    <button onclick="serverManager.logout()" class="btn btn-secondary" style="margin-left: 10px; padding: 8px 12px; font-size: 0.8rem;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            `;
        }

        logout() {
            sessionStorage.removeItem('discord_access_token');
            window.location.href = '../';
        }
    }

    // Initialize server manager
    const serverManager = new ServerManager(serverId);
    window.serverManager = serverManager;

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
</script>
</body>
</html>
